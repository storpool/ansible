---
- name: Define sp_release_method
  import_tasks: "subtasks/sp_release_method.yml"

- name: Get StorPool packages
  import_tasks: "subtasks/get_storpool/storpool_{{ sp_release_method | default('web') }}.yml"

- name: Configure kernel version and parameters
  import_tasks: "subtasks/configure_kernel.yml"

- name: Test Memory - check on async task
  become: true
  async_status:
    jid: "{{ memory_test_sleeper.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 200
  delay: 30
  when:
    - sp_vm is defined
    - not sp_vm | bool
    - memory_test_sleeper is defined
    - memory_test_sleeper.ansible_job_id is defined

- name: Install StorPool modules
  become: true
  command:
    cmd: >-
      {{ sp_install_helper }}
      -g {{ sp_release | quote }}
      {{ '-r' if sp_reinstall else '' }}
      -w {{ sp_toolsdir | quote }}
      -m {{ sp_install_services | quote }}
      {% if sp_retry_install %}
      --retry 2
      {% endif %}
    chdir: "{{ sp_toolsdir }}"
  async: 1000
  poll: 0
  register: storpool_modules_sleeper
  changed_when: false

- name: Install StorPool modules - check on async task
  become: true
  async_status:
    jid: "{{ storpool_modules_sleeper.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 100
  delay: 5
  changed_when: false
