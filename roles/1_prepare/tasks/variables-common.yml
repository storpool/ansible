---
- name: Assign StorPool roles
  set_fact:
    cacheable: true
    sp_roles: "{{ sp_roles | combine([{item: true}]) }}"
  with_items:
    - client
    - mgmt
    - iscsi
    - bridge
    - debug
  when:
    - item in sp_roles_list

- name: Populate false values for StorPool roles 
  set_fact:
    cacheable: true
    sp_roles: "{{ sp_roles | combine([{item: false}]) }}"
  when:
    - item not in sp_roles.keys()
  with_items:
    - client
    - mgmt
    - iscsi
    - bridge
    - debug

- name: Define StorPool services to install
  block:
    - name: Initial definition of services_to_install
      set_fact:
        services_to_install: "{{ 'server' if inventory_hostname in groups['storpool_servers'] }}"
    - name: Validate and define services_to_install variable
      set_fact:
        services_to_install: "{{item}} {{services_to_install}}"
      when:
        - sp_roles[item]
      with_items:
        - iscsi
        - mgmt
        - bridge
        - debug
    - name: Cache sp_install_services fact 
      set_fact:
        sp_install_services: "@block cli {{services_to_install}}"
        cacheable: true
